<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IQ Тест</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
            colors: {
              apple: {
                gray: '#F5F5F7',
                dark: '#1D1D1F',
                blue: '#0071E3',
                card: '#FFFFFF',
              }
            },
            animation: {
              'fade-in-up': 'fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
              'fade-in': 'fadeIn 0.8s ease-out',
              'pulse-slow': 'pulse 3s infinite',
            },
            keyframes: {
              fadeInUp: {
                '0%': { opacity: 0, transform: 'translateY(20px)' },
                '100%': { opacity: 1, transform: 'translateY(0)' },
              },
              fadeIn: {
                '0%': { opacity: 0 },
                '100%': { opacity: 1 },
              }
            }
          },
        },
      }
    </script>
    <style>
      body {
        background-color: #F5F5F7;
        -webkit-font-smoothing: antialiased;
      }
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
    <!-- Import Map for ES Modules -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@19.2.3",
    "react-dom/client": "https://esm.sh/react-dom@19.2.3/client",
    "lucide-react": "https://esm.sh/lucide-react@0.562.0",
    "d3": "https://esm.sh/d3@7.9.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
  </head>
  <body>
    <div id="root"></div>

    <!-- Application Logic Inlined for Robustness -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useMemo } from 'react';
      import ReactDOM from 'react-dom/client';
      import { 
        ArrowRight, Brain, ChevronRight, Clock, 
        Share2, RefreshCw, CheckCircle, XCircle,
        Square, Circle, Triangle, Hexagon, Box, Layers, Hash, 
        HelpCircle, Disc, ArrowRight as ArrowIcon
      } from 'lucide-react';
      import * as d3 from 'd3';

      // --- Constants ---

      const QUESTIONS = [
        {
          id: 'q1_sequence',
          title: 'Числовая последовательность',
          subtitle: 'Продолжите ряд: 1, 1, 2, 3, 5, 8, ...',
          options: [
            { id: '11', label: '11', isCorrect: false, icon: <Hash className="w-6 h-6 text-gray-500" /> },
            { id: '12', label: '12', isCorrect: false, icon: <Hash className="w-6 h-6 text-gray-500" /> },
            { id: '13', label: '13', isCorrect: true, description: 'Сумма двух предыдущих (Фибоначчи)', icon: <Hash className="w-6 h-6 text-gray-500" /> },
            { id: '15', label: '15', isCorrect: false, icon: <Hash className="w-6 h-6 text-gray-500" /> },
          ]
        },
        {
          id: 'q2_analogy',
          title: 'Аналогия',
          subtitle: 'Квадрат относится к Кубу, как Круг относится к ...',
          options: [
            { id: 'oval', label: 'Овалу', isCorrect: false, icon: <Circle className="w-6 h-6 text-gray-500 scale-y-75" /> },
            { id: 'sphere', label: 'Сфере', isCorrect: true, description: '3D эквивалент круга', icon: <Circle className="w-6 h-6 text-gray-500" /> },
            { id: 'cylinder', label: 'Цилиндру', isCorrect: false, icon: <Layers className="w-6 h-6 text-gray-500" /> },
            { id: 'triangle', label: 'Треугольнику', isCorrect: false, icon: <Triangle className="w-6 h-6 text-gray-500" /> },
          ]
        },
        {
          id: 'q3_logic',
          title: 'Логический вывод',
          subtitle: 'Если все Блупы — это Разии, а все Разии — это Лазии, то...',
          options: [
            { id: 'opt1', label: 'Все Блупы — Лазии', isCorrect: true, icon: <ArrowIcon className="w-6 h-6 text-gray-500" /> },
            { id: 'opt2', label: 'Некоторые Лазии — Блупы', isCorrect: false, icon: <ArrowIcon className="w-6 h-6 text-gray-500" /> },
            { id: 'opt3', label: 'Нет связи', isCorrect: false, icon: <HelpCircle className="w-6 h-6 text-gray-500" /> },
            { id: 'opt4', label: 'Все Лазии — Блупы', isCorrect: false, icon: <ArrowIcon className="w-6 h-6 text-gray-500" /> },
          ]
        },
        {
          id: 'q4_odd_one_out',
          title: 'Лишнее слово',
          subtitle: 'Какое слово не подходит по смыслу?',
          options: [
            { id: 'carrot', label: 'Морковь', isCorrect: false, icon: <Disc className="w-6 h-6 text-gray-400" /> },
            { id: 'potato', label: 'Картофель', isCorrect: false, icon: <Disc className="w-6 h-6 text-gray-400" /> },
            { id: 'onion', label: 'Лук', isCorrect: false, icon: <Disc className="w-6 h-6 text-gray-400" /> },
            { id: 'apple', label: 'Яблоко', isCorrect: true, description: 'Это фрукт, остальные овощи', icon: <Disc className="w-6 h-6 text-gray-400" /> },
          ]
        },
        {
          id: 'q5_math_pattern',
          title: 'Сложный ряд',
          subtitle: 'Какое число следует дальше: 7, 10, 8, 11, 9, 12, ...',
          options: [
            { id: '10', label: '10', isCorrect: true, description: 'Закономерность: +3, -2', icon: <Hash className="w-6 h-6 text-gray-500" /> },
            { id: '13', label: '13', isCorrect: false, icon: <Hash className="w-6 h-6 text-gray-500" /> },
            { id: '7', label: '7', isCorrect: false, icon: <Hash className="w-6 h-6 text-gray-500" /> },
            { id: '14', label: '14', isCorrect: false, icon: <Hash className="w-6 h-6 text-gray-500" /> },
          ]
        },
        {
          id: 'q6_spatial',
          title: 'Пространственное мышление',
          subtitle: 'Сколько углов у гексагона?',
          options: [
            { id: '4', label: 'Четыре', isCorrect: false, icon: <Square className="w-6 h-6 text-gray-500" /> },
            { id: '5', label: 'Пять', isCorrect: false, icon: <Triangle className="w-6 h-6 text-gray-500" /> },
            { id: '6', label: 'Шесть', isCorrect: true, icon: <Hexagon className="w-6 h-6 text-gray-500" /> },
            { id: '8', label: 'Восемь', isCorrect: false, icon: <Box className="w-6 h-6 text-gray-500" /> },
          ]
        }
      ];

      // --- Utilities ---

      function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
      }

      // --- Components ---

      const Welcome = ({ onStart }) => {
        return (
          <div className="flex flex-col items-center justify-center min-h-[80vh] text-center px-6 animate-fade-in-up">
            <div className="w-24 h-24 bg-white rounded-3xl shadow-xl flex items-center justify-center mb-8 border border-gray-100">
              <Brain className="w-12 h-12 text-apple-blue" />
            </div>
            
            <h1 className="text-4xl md:text-6xl font-bold text-apple-dark mb-4 tracking-tight">
              Тест на IQ
            </h1>
            
            <p className="text-lg md:text-xl text-gray-500 max-w-xl mb-12 leading-relaxed">
              Пройдите этот профессиональный тест из 6 вопросов, чтобы узнать свой приблизительный коэффициент интеллекта. Учитывается точность ответов и время реакции.
            </p>
            
            <button 
              onClick={onStart}
              className="group relative flex items-center justify-center gap-3 bg-apple-blue text-white px-10 py-4 rounded-full text-lg font-medium transition-all hover:scale-105 active:scale-95 shadow-lg hover:shadow-xl hover:bg-blue-600"
            >
              Начать Тест
              <ArrowRight className="w-5 h-5 transition-transform group-hover:translate-x-1" />
            </button>

            <div className="mt-16 text-sm text-gray-400">
              Включает таймер &bull; Логика и анализ
            </div>
          </div>
        );
      };

      const QuestionScreen = ({ question, onSelect, currentStep, totalSteps }) => {
        const [seconds, setSeconds] = useState(0);

        // Memoize shuffled options so they don't reshuffle on timer tick
        const shuffledOptions = useMemo(() => {
          return shuffleArray(question.options);
        }, [question]);

        useEffect(() => {
          setSeconds(0);
          const interval = setInterval(() => {
            setSeconds(s => s + 1);
          }, 1000);
          return () => clearInterval(interval);
        }, [question]);

        return (
          <div className="w-full max-w-2xl mx-auto px-4 pt-8 animate-fade-in-up">
            {/* Top Bar */}
            <div className="flex items-center justify-between mb-8">
              <div className="text-sm font-medium text-gray-400">
                Вопрос {currentStep} из {totalSteps}
              </div>
              <div className="flex items-center gap-2 text-sm font-medium text-apple-blue bg-blue-50 px-3 py-1 rounded-full">
                <Clock className="w-4 h-4" />
                {Math.floor(seconds / 60)}:{String(seconds % 60).padStart(2, '0')}
              </div>
            </div>

            <div className="w-full h-1.5 bg-gray-200 rounded-full mb-12 overflow-hidden">
              <div 
                className="h-full bg-apple-blue rounded-full transition-all duration-700 ease-out"
                style={{ width: `${(currentStep / totalSteps) * 100}%` }}
              />
            </div>

            {/* Question Header */}
            <div className="mb-10">
              <h2 className="text-3xl font-bold text-apple-dark mb-3 tracking-tight">
                {question.title}
              </h2>
              {question.subtitle && (
                <p className="text-lg text-gray-500">
                  {question.subtitle}
                </p>
              )}
            </div>

            {/* Options Grid */}
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              {shuffledOptions.map((option) => (
                <button
                  key={option.id}
                  onClick={() => onSelect(option)}
                  className="group flex flex-col items-start p-6 bg-white rounded-2xl border-2 border-transparent hover:border-apple-blue shadow-sm hover:shadow-md transition-all duration-200 text-left"
                >
                  <div className="mb-4 p-3 bg-gray-50 rounded-xl group-hover:bg-blue-50 transition-colors">
                    {option.icon}
                  </div>
                  <div className="font-semibold text-lg text-apple-dark mb-1">
                    {option.label}
                  </div>
                  
                  <div className="mt-auto pt-4 flex items-center text-apple-blue opacity-0 group-hover:opacity-100 transition-opacity text-sm font-medium">
                    Выбрать <ChevronRight className="w-4 h-4 ml-1" />
                  </div>
                </button>
              ))}
            </div>
          </div>
        );
      };

      const ResultScreen = ({ selections, totalTime, onRestart }) => {
        const [displayedIQ, setDisplayedIQ] = useState(0);
        const [showDetails, setShowDetails] = useState(false);
        
        // Calculate Score
        let correctCount = 0;
        Object.values(selections).forEach(option => {
          if (option.isCorrect) correctCount++;
        });

        // Strict IQ Logic
        let calculatedIQ = 0;
        if (correctCount < 3) {
          calculatedIQ = 70 + (correctCount * 5); 
        } else {
          const baseIQ = 90 + ((correctCount - 3) * 10);
          const timeDelta = 45 - totalTime;
          calculatedIQ = baseIQ + timeDelta;
        }

        // Clamping
        if (calculatedIQ > 148) calculatedIQ = 148;
        if (calculatedIQ < 70) calculatedIQ = 70;

        useEffect(() => {
          const duration = 2500;
          const iqInterpolator = d3.interpolateNumber(70, calculatedIQ);

          const timer = d3.timer((elapsed) => {
            const t = Math.min(1, elapsed / duration);
            const easeT = d3.easeCubicOut(t);
            setDisplayedIQ(Math.round(iqInterpolator(easeT)));

            if (t >= 1) {
              timer.stop();
              setTimeout(() => setShowDetails(true), 500);
            }
          });

          return () => timer.stop();
        }, [calculatedIQ]);

        const getWittyComment = (iq) => {
          if (iq >= 140) return "Вы, случайно, не переписываете код Вселенной по выходным?";
          if (iq >= 130) return "Ваш мозг — суперкомпьютер. Осторожно, не перегрейтесь.";
          if (iq >= 120) return "Острее бритвы Оккама. Вы видите решения, которые другие не замечают.";
          if (iq >= 110) return "Отличный результат! Вы тот самый друг, который объясняет правила настолок.";
          if (iq >= 100) return "Золотая середина. Соль земли и двигатель прогресса.";
          if (iq >= 90) return "Нормально. Главное не победа, а участие (и здравый смысл).";
          if (iq >= 80) return "Вы не любите усложнять. Простые решения — самые надежные.";
          return "Эйнштейн тоже плохо учился в школе (это миф, но вам будет приятно).";
        };

        const getLabel = (iq) => {
          if (iq >= 135) return { text: "Гениальность", color: "text-purple-600", bg: "bg-purple-50" };
          if (iq >= 120) return { text: "Высокий интеллект", color: "text-blue-600", bg: "bg-blue-50" };
          if (iq >= 100) return { text: "Средний уровень", color: "text-green-600", bg: "bg-green-50" };
          if (iq >= 85) return { text: "Ниже среднего", color: "text-orange-600", bg: "bg-orange-50" };
          return { text: "Низкий результат", color: "text-red-600", bg: "bg-red-50" };
        };

        const label = getLabel(calculatedIQ);
        const wittyComment = getWittyComment(calculatedIQ);

        // Distribution Chart Calculation
        const minIQ = 55;
        const maxIQ = 165;
        const percentilePosition = Math.min(100, Math.max(0, ((displayedIQ - minIQ) / (maxIQ - minIQ)) * 100));

        const handleShare = async () => {
          const shareData = {
            title: 'Мой IQ результат',
            text: `Я прошел тест и мой IQ равен ${Math.round(calculatedIQ)}! ${wittyComment}`,
            url: window.location.href.startsWith('http') ? window.location.href : undefined
          };

          if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
            try {
              await navigator.share(shareData);
            } catch (err) {
              console.error("Share failed:", err);
              alert(`Ваш результат: ${calculatedIQ}. Скриншот приветствуется!`);
            }
          } else {
            alert(`Ваш результат: ${calculatedIQ}. Скриншот приветствуется!`);
          }
        };

        return (
          <div className="w-full max-w-3xl mx-auto px-4 pb-20 animate-fade-in pt-8">
            
            {/* Main Result Card */}
            <div className="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden mb-8 border border-gray-100">
              <div className="p-8 md:p-12 flex flex-col items-center text-center">
                
                <div className={`mb-8 px-5 py-2 rounded-full text-sm font-bold uppercase tracking-wide ${label.bg} ${label.color}`}>
                  {label.text}
                </div>

                <h2 className="text-gray-400 text-lg font-medium mb-2 uppercase tracking-widest text-xs">
                  Ваш результат
                </h2>
                
                <div className="relative mb-6">
                   <h1 className="text-9xl font-bold text-apple-dark tracking-tighter leading-none">
                    {displayedIQ}
                  </h1>
                </div>

                <p className="text-lg font-medium text-apple-dark max-w-lg mx-auto mb-10 italic">
                  "{wittyComment}"
                </p>

                {/* Visualization Graph */}
                <div className="w-full max-w-md mb-12">
                   <div className="flex justify-between text-xs font-bold text-gray-300 uppercase mb-2">
                     <span>Низкий</span>
                     <span>Средний</span>
                     <span>Высокий</span>
                   </div>
                   <div className="relative h-4 w-full bg-gray-100 rounded-full overflow-hidden">
                     {/* Gradient Background representing distribution */}
                     <div className="absolute inset-0 bg-gradient-to-r from-red-300 via-green-300 to-purple-400 opacity-50"></div>
                     {/* Vertical markers */}
                     <div className="absolute top-0 bottom-0 w-0.5 bg-white left-[25%]"></div>
                     <div className="absolute top-0 bottom-0 w-0.5 bg-white left-[50%]"></div>
                     <div className="absolute top-0 bottom-0 w-0.5 bg-white left-[75%]"></div>
                   </div>
                   
                   {/* Pointer */}
                   <div className="relative h-6 w-full mt-1">
                     <div 
                        className="absolute top-0 transform -translate-x-1/2 transition-all duration-300 flex flex-col items-center"
                        style={{ left: `${percentilePosition}%` }}
                     >
                       <div className="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-b-[8px] border-b-apple-dark"></div>
                       <div className="text-[10px] font-bold text-apple-dark mt-1 bg-white px-1.5 py-0.5 rounded shadow-sm border border-gray-100">
                         ВЫ
                       </div>
                     </div>
                   </div>
                </div>

                <div className="grid grid-cols-2 gap-4 w-full max-w-sm mb-10">
                   <div className="bg-gray-50 p-5 rounded-2xl border border-gray-100">
                      <div className="text-xs text-gray-400 uppercase font-semibold mb-1">Точность</div>
                      <div className="text-3xl font-bold text-apple-dark">{correctCount} / 6</div>
                   </div>
                   <div className="bg-gray-50 p-5 rounded-2xl border border-gray-100">
                      <div className="text-xs text-gray-400 uppercase font-semibold mb-1">Время</div>
                      <div className="text-3xl font-bold text-apple-dark">{totalTime}с</div>
                   </div>
                </div>

                <div className="w-full h-px bg-gray-100 mb-8"></div>

                {/* Action Bar */}
                <div className="flex flex-col sm:flex-row items-center justify-center gap-4 w-full">
                  <button 
                    onClick={handleShare}
                    className="w-full sm:w-auto flex items-center justify-center gap-2 px-8 py-4 bg-white text-apple-dark border border-gray-200 rounded-full font-bold hover:bg-gray-50 transition-all active:scale-95"
                  >
                    <Share2 className="w-5 h-5" /> Поделиться
                  </button>
                  <button 
                    onClick={onRestart}
                    className="w-full sm:w-auto flex items-center justify-center gap-2 px-8 py-4 bg-apple-dark text-white rounded-full font-bold hover:bg-gray-800 transition-all shadow-lg hover:shadow-xl active:scale-95"
                  >
                    <RefreshCw className="w-5 h-5" /> Пройти снова
                  </button>
                </div>
              </div>
            </div>

            {/* Breakdown Section */}
            <div className={`transition-all duration-1000 transform ${showDetails ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10'}`}>
              <h3 className="text-center text-gray-400 mb-6 font-medium text-sm uppercase tracking-widest">Детализация ответов</h3>

              <div className="space-y-4">
                {Object.entries(selections).map(([questionId, option]) => {
                  const question = QUESTIONS.find(q => q.id === questionId);
                  return (
                    <div key={questionId} className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between group hover:shadow-md transition-shadow">
                      <div className="flex items-center gap-4">
                        <div className={`w-12 h-12 rounded-full flex items-center justify-center shrink-0 ${option.isCorrect ? 'bg-green-100 text-green-600' : 'bg-red-50 text-red-500'}`}>
                          {option.isCorrect ? <CheckCircle className="w-6 h-6" /> : <XCircle className="w-6 h-6" />}
                        </div>
                        <div>
                          <div className="text-xs text-gray-400 font-bold uppercase tracking-wider mb-1">{question?.title}</div>
                          <div className="text-base font-semibold text-apple-dark leading-tight">{option.label}</div>
                        </div>
                      </div>
                      {option.description && (
                        <div className="hidden sm:block text-sm text-gray-400 max-w-[200px] text-right leading-tight">
                          {option.description}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        );
      };

      // --- App ---

      const AppState = {
        WELCOME: 0,
        QUESTIONS: 1,
        CALCULATING: 2,
        RESULT: 3
      };

      function App() {
        const [appState, setAppState] = useState(AppState.WELCOME);
        const [questions, setQuestions] = useState([]);
        const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
        const [userSelections, setUserSelections] = useState({});
        
        // Timer State
        const [startTime, setStartTime] = useState(0);
        const [totalTime, setTotalTime] = useState(0);

        const handleStart = () => {
          // Shuffle questions when starting
          setQuestions(shuffleArray(QUESTIONS));
          setAppState(AppState.QUESTIONS);
          setCurrentQuestionIndex(0);
          setUserSelections({});
          setStartTime(Date.now());
        };

        const handleOptionSelect = (option) => {
          const currentQuestion = questions[currentQuestionIndex];
          const newSelections = { ...userSelections, [currentQuestion.id]: option };
          setUserSelections(newSelections);

          if (currentQuestionIndex < questions.length - 1) {
            setTimeout(() => {
              setCurrentQuestionIndex(prev => prev + 1);
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 200);
          } else {
            // Calculate total time
            const endTime = Date.now();
            setTotalTime(Math.round((endTime - startTime) / 1000));
            
            setAppState(AppState.CALCULATING);
            setTimeout(() => {
              setAppState(AppState.RESULT);
              window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 2500);
          }
        };

        const handleRestart = () => {
          setAppState(AppState.WELCOME);
          setUserSelections({});
          setCurrentQuestionIndex(0);
          setTotalTime(0);
        };

        return (
          <div className="min-h-screen font-sans selection:bg-apple-blue selection:text-white pb-12">
            {/* Header / Nav */}
            <nav className="w-full p-6 flex justify-between items-center max-w-5xl mx-auto">
              <div className="text-xl font-bold tracking-tight text-apple-dark flex items-center gap-2">
                <div className="w-3 h-3 bg-apple-blue rounded-full"></div>
                IQ Test
              </div>
            </nav>

            <main className="container mx-auto max-w-4xl">
              {appState === AppState.WELCOME && (
                <Welcome onStart={handleStart} />
              )}

              {appState === AppState.QUESTIONS && questions.length > 0 && (
                <QuestionScreen 
                  question={questions[currentQuestionIndex]}
                  onSelect={handleOptionSelect}
                  currentStep={currentQuestionIndex + 1}
                  totalSteps={questions.length}
                />
              )}

              {appState === AppState.CALCULATING && (
                <div className="flex flex-col items-center justify-center min-h-[60vh]">
                  <div className="relative w-24 h-24 mb-8">
                    <div className="absolute inset-0 border-t-4 border-apple-blue rounded-full animate-spin"></div>
                    <div className="absolute inset-2 border-t-4 border-gray-200 rounded-full opacity-30"></div>
                  </div>
                  <h2 className="text-3xl font-bold text-apple-dark animate-pulse mb-3">Обработка...</h2>
                  <p className="text-gray-400 text-lg">Анализ паттернов и времени реакции</p>
                </div>
              )}

              {appState === AppState.RESULT && (
                <ResultScreen 
                  selections={userSelections} 
                  totalTime={totalTime}
                  onRestart={handleRestart}
                />
              )}
            </main>
          </div>
        );
      }

      // --- Mount ---

      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>